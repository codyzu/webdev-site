# Cloud

What is the cloud?

The cloud is made up of managed computing resource, services and storage. When creating a cloud application, the goal is to save time by not needing to configure servers and possibly save money by not needing to purchase computer hardware.

There are three large cloud providers:
- Amazon AWS
- Google Cloud Services
- Microsoft Azure

Cloud services are generally billed using a "pay-as-you-go" model, meaning you pay for the resources used.

# Firebase

[Firebase](https://firebase.google.com/) is a mobile and web application development platform integrated with Google Cloud Services.

As a **web developer**, Firebase offers several useful services listed below.

**Firebase provides a very [generous free, no credit card required, plan](https://firebase.google.com/pricing) allowing for development and deployment a production grade application.**

## Hosting

[Firebase Hosting](https://firebase.google.com/products/hosting/) offers easy global deployment of web assets with free SSL security certificates.

## Cloud Functions

[Firebase Cloud Functions](https://firebase.google.com/products/functions/) allows developing a backend with no servers.

## Database

## Storage

## Firebase

## Firebase Project

### Create a new Firebase Project

1. [https://console.firebase.google.com](https://console.firebase.google.com)
1. Sign in to your google account
1. "Add project"
1. Give your project a unique name, keep the default settings, and accept all of the options:
   ![new project](images/firebase-add-project-annotated.jpg)

### Enable Firestore NoSQL Database in the Firebase Console

1. Navigate to Database and click "Create Database"

   ![create database](images/create-database-annotated.jpg)

1. Choose "Start in test mode". _‚ö† Note the security warning: **your database is open for anyone to read/write!**_ Click "Create project".

   ![security rules](images/security-rules-annotated.jpg)

## Add Firebase into your project

1. Start in the root of your calculator project (the same directory as your `package.json` file).

1. Build your react project:
   ```cmd
   yarn build
   ```
   _Note: you now have a `build` directory containing the files required to deploy your application._

1. Add the firebase-tools package
   ```cmd
   yarn add --dev firebase-tools
   ```

1. Add a npm run-script to make it easier to run.

   `package.json`:
   ```javascript
   // ...

   "scripts": {
     // ...
     "firebase": "firebase"
   },

   // ...
   ```

1. Login to Firebase:
   ```cmd
   npm run firebase -- --help
   npm run firebase -- login
   ```

## Firebase hosting

1. Enable Firebase hosting:
   ```cmd
   npm run firebase -- init
   ```
   1. Enable `Hosting` with the space bar and then press enter.
   1. Select your firebase project.
   1. _"What do you want to use as your public directory? (public)"_: **enter `build`**, the directory containing your built react application.
   1. _"Configure as a single-page app (rewrite all urls to /index.html)?"_: **enter `y`** because our react application is a single page application.
   1. _"File build/index.html already exists. Overwrite?"_: **enter `n`** since we want to use the `index.html` generated by the react build process.

   üí° _Note that Firebase added 2 new files, `.firebaserc` that remembers which firebase project to use by default and `firebase.json` that contains some firebase settings, including those that you configured above._

1. Deploy your application!
   ```cmd
   npm run firebase -- deploy
   ```

1. Navigate to the URL provided by firebase in console. It should resemble: `https://{your project name}.firebaseapp.com`

   Try accessing your site with smartphone. You just deployed your first site, with SSL, to the cloud... for free!

1. In your browser, in the Firebase console, go to the "Hosting" page. Here you could associate a custom domain. You can also see your deployment history with the option to rollback to a previous deployment.

## Firebase functions

1. Enable Firebase hosting:
   ```cmd
   npm run firebase -- init
   ```
   
   1. Choose "Functions"
   1. Select "JavaScript"
   1. "Do you want to use ESLint to catch probable bugs and enforce style?" **enter `n`**
   1. "Do you want to install dependencies with npm now?" **enter `n`**

1. Modify your functions to use the [node.js version 8 runtime](https://firebase.google.com/docs/functions/manage-functions#set_nodejs_version).

   In `functions/package.json` add:
   ```
   "engines": {
     "node": "8"
   },
   ```

1. Install the dependencies with yarn (or npm):
   ```cmd
   cd functions
   yarn --ignore-engines
   ```

   ‚ö†Ô∏è _Note: `yarn` or `yarn install` will enforce the engine that we added to `package.json`. Therefore, we should use the `--ignore-engines` flag with yarn or use `npm install`._

1. In vscode, open `functions/index.js` and **un-comment** all of the lines of code.

1. Open the `firebase.json` file. Add a rewrite rule so that you function is accessible in the same domain as your hosting. Your rewrite rules should resemble the following:
   ```json
   "rewrites": [
     {
       "source": "/helloWorld",
       "function": "helloWorld"
     },
     {
       "source": "**",
       "destination": "/index.html"
     }
   ]
   ```

1. You just deployed your first serverless cloud function! You can access either directly in the URL listed in the console:
   
   `https://us-central1-{your project name}.cloudfunctions.net/helloWorld`

   Or at the path that we configured in the hosting:

   `https://{your project name}.firebaseapp.com/helloWorld`

   ‚òùÔ∏è Take a moment to appreciate what we now have. A website deployed, with javascript backend configured to exact routes. **Plus, we never configured a server, virtual machine, docker, or paid for hosting!**

üí° The function `onRequest()` accepts supports routers and apps from [Express.js](https://expressjs.com/fr/). In our example, we use a function `(request, response) => { ... }`. The `request` and `response` objects are the same `req` and `res` that we used in Express.

#### Exercise 1: Add a function to `functions/index.js` named `helloData` that accepts a name as a query parameter and returns it in JSON, i.e. `{name: 'cody'}`.

1. use `response.send()` to send and object in the response
1. query parameters, i.e. `/helloData?name=cody` are parsed into the `request.query`, i.e. `request.query.name`.
1. you can debug your function by adding logging statements, i.e. `console.log(request.query)` and reading them with `npm run firebase -- functions:log` (there will be some delay)
1. ‚ö†Ô∏è don't forget to add a rewrite rule for `helloData` to your `firebase.json` file!

#### Question 1: What is the content type of the response? (Hint: use the inspector)

#### Exercise 2: Add a function to `functions/index.js` named `helloHtml` that accepts a name as a query parameter and returns it in HTML, i.e. `<h1>hello cody</h1>`.

1. use `response.send()` to send an HTML document, i.e. `<html><body><h1>...</h1></body></html>`
1. use query parameters to parse the name
1. ‚ö†Ô∏è don't forget to add a rewrite rule for `helloData` to your `firebase.json` file!

#### Question 2: What is the content type of the response? (Hint: use the inspector)

#### Bonus 1: See [pug renderFile](https://pugjs.org/api/reference.html#pugrenderfilepath-options-callback) for how you might use pug to render a complete HTML template.

## Why Functions?

Firebase Cloud Functions
- Functions as a Service (FaaS)
- Serverless

What is possible?

Types of triggers:

## Call them directly

- HTTPS request (our example above)
- From a Firebase application (automatic authentication)

Examples:
- Perform complex calculations (i.e. algorithms not suited for portable phone)
- Add dynamic pages to a static site
- Call external APIs (i.e. AI & ML)
- Authenticate and perform "admin" actions
- Perform routine maintenance with cron service (i.e. delete "old" data for GDPR)

## Triggered by events in Firestore

- New document
- Modified document
- Deleted document

Examples:
- Update aggregations (i.e. rating average and count)
- Send notifications (i.e. notify user when they have a new follower)
- Delete associated data (i.e. delete all ratings when a post is deleted)
- Sanitize text (i.e. remove profanity from comments)

## Triggered by events in Cloud Storage

- File saved
- File deleted

Examples:
- Generate thumbnail or lower quality version of an image

## Triggered by authentication

- New user
- User deleted

Examples:
- Send welcome email when user joins
- Create default data when user joins
- Delete associated data when user deletes their account

Refer to the [Firebase documentation](https://firebase.google.com/docs/functions/use-cases) for more use cases.

## Add a "route" or page to the calculator

A router lets us navigate between pages inside the browser. This is known as client side routing and is a core concept in a single page application (SPA).

Client side routing consists of 2 primary tasks:
* conditionally rendering components based on the current URL
* providing a mechanism to navigate to new urls without making calls to the server (keeping the forward and back buttons working)

For this activity, we will use the [React Router](https://reacttraining.com/react-router/) for the browser: [react-router-dom](https://reacttraining.com/react-router/web/guides/philosophy).

1. Create a new file `src/Calculator.js` and move all of the components from your `index.js` file to the new file, i.e. (`Button`, `KeyRow`, `KeyPad`, `Calculator`). Export the `Calculator` component at the end of the file:

   ```javascript
   import React, {useState, useReducer} from 'react';

   // ...
   // your components here
   // ...

   const Calculator = () => {
     // ...
   }

   export default Calculator;
   ```

1. Import the `Calculator` component in `index.js`:

   ```javascript
   import React from 'react';
   import ReactDOM from 'react-dom';
   import 'bootstrap/dist/css/bootstrap.min.css';
   import 'bootstrap';
   import Calculator from './Calculator';


   ReactDOM.render(
     <Calculator />,
     document.getElementById('root')
   );
   ```

1. Test your calculator using `yarn start` to ensure it is still working.

1. Add `react-router-dom` to your project:
   ```
   yarn add react-router-dom
   ```

1. Add a new component named `History` in `src/History.js`:
   ```jsx
   import React from 'react';

   const History = () => <h1>history</h1>;

   export default History;
   ```

1. In `index.js` we have to make the following changes:
   * Create an `App` component
   * Surround the `App` with the `BrowserRouter` component from react-router-dom
   * Inside the `App` component, add a `Switch` that contains `Routes` to `Calculator` and `History`

   ```jsx
   import React from 'react';
   import ReactDOM from 'react-dom';
   import 'bootstrap/dist/css/bootstrap.min.css';
   import 'bootstrap';
   import Calculator from './Calculator';
   import History from './History';
   import {BrowserRouter, Switch, Route, Link} from 'react-router-dom';

   // The App component as a switch with our routes
   const App = () => 
     <Switch>
       <Route exact path='/' component={Calculator} />
       <Route exact path='/history' component={History} />
     </Switch>;

   // The app MUST be surrounded by the BrowserRouter
   ReactDOM.render(
     <BrowserRouter>
       <App />
     </BrowserRouter>,
     document.getElementById('root')
   );
   ```

1. Test the 2 routes in your browser. Navigate to http://localhost:3000 and http://localhost:3000/history Notice what happens if you change the `path` in one of the `Routes`.

1. Finally, we can add some navigation between the 2 routes. Inside `src/index.js`, add 2 `Link`'s to the `App` component for navigating between the 2 pages:

   ```jsx
   const App = () => 
     <>
       <Link to='/'>Home</Link> <Link to='/history'>History</Link>
       <Switch>
         <Route exact path='/' component={Calculator} />
         <Route exact path='/history' component={History} />
       </Switch>
     </>
   ```

   ‚ö†Ô∏è A component must have 1 parent tag. Here we used react [fragment](https://reactjs.org/docs/fragments.html) syntax `<> ... </>` tags to wrap our components.

#### Exercise 3: inspect the network calls in the browser:

* What happens when you click on the `Link`'s you added?
* What happens when you use the back and forward buttons?
* What happens when you change the URL in the address bar?

## Client and Server links

   1. Add an anchor `<a href="...">` link to your cloud function inside the `App` component to link to your `helloWorld` cloud function.

   ```jsx
   const App = () => 
     <>
       <Link to='/'>Home</Link> <Link to='/history'>History</Link> <a href="/helloWorld">Hello</a>
       <Switch>
         <Route exact path='/' component={Calculator} />
         <Route exact path='/history' component={History} />
       </Switch>
     </>
   ```

   1. Locally, the new link won't work. Instead, no components after the links will get rendered.

   1. Deploy your entire application to Firebase:
   ```cmd
   yarn build
   npm run firebase -- deploy
   ```

   1. You just deployed an react application that consists of both client and server side code! Click on the links and see that some navigation happens in browser and some happens inside the cloud function.

#### Bonus: Add the code to make the `Link` bold when you navigate to page. i.e. When the calculator is displayed, the `Home` link should be bold. When the history page is displayed, the `History` link should be bold.

üí° Hint: replace `Link` with `NavLink` (see the [documentation here](https://reacttraining.com/react-router/web/api/NavLink) and the example for the `activeStyles` property).




fetch saved data from cloud function in new route

Bonus read/write data to firestore
